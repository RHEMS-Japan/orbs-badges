description: >
  Generate badges from the services of RHEMS BADGES.

parameters:
  ssh_key:
    type: string
    default: BADGE_SSH_KEY
    description: "fingerprints. (Required)"
  file_path:
    type: string
    default: ./README.md
    description: "path of README.md"
  branch:
    type: string
    default: $CIRCLE_BRANCH
    description: "if branche is empty it will use ${CIRCLE_BRANCH} (optional)"
  user_name:
    type: string
    default: "Mr.badges"
    description: "GitHub user.name"
  user_email:
    type: string
    default: "badges@rhems-japan.co.jp"
    description: "GitHub user.email"

steps:
    - add_ssh_keys:
        fingerprints:
        - <<parameters.ssh_key>>
    - checkout
    - run:
        name: Readme update
        command: |
          sed -i -e "s#branch=.*\&cised=true.*#branch=<<parameters.branch>>\&cised=true\&update=$(date "+%Y%m%d-%H%M%S")\)#g"  << parameters.file_path >>
    - run:
        name: git push
        command: |
          git config --global user.email << parameters.user_email >>
          git config --global user.name << parameters.user_name >>
          git add << parameters.file_path >>
          git commit -m '[skip ci] << parameters.file_path >> Update'
          git push origin $CIRCLE_BRANCH
